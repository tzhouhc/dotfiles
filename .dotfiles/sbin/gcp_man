#!/bin/bash

# ---
# A script to interactively start or stop GCP compute instances in us-east zones.
#
# Dependencies:
# - gcloud CLI (authenticated)
# - gum CLI (https://github.com/charmbracelet/gum)
# ---

# Style definitions for gum
GUM_CHOOSE_HEADER_STYLE="--header.foreground='15' --header.background='24' --header.padding='1 2' --header.bold"
GUM_FILTER_HEADER_STYLE="--header.foreground='15' --header.background='5' --header.padding='1 2' --header.bold"
GUM_SPIN_STYLE="--spinner.foreground='212' --title.foreground='212'"

TMP_FILE="/tmp/gcp_instances.txt"

if ! type gcloud &>/dev/null; then
  echo "This tool relies on the gcloud CLI."
fi

if ! type gum &>/dev/null; then
  echo "This tool relies on gum CLI (https://github.com/charmbracelet/gum)."
fi

if [[ -z "$GCP_ZONES" ]]; then
  GCP_ZONES="us-east1-d, us-east4-c, us-west1-c, us-west4-a"
fi

# 1. Fetch all instances from us-east zones
gum spin "${GUM_SPIN_STYLE}" --title "Fetching instances from all relevant zones..." -- \
gcloud compute instances list --filter="zone:($GCP_ZONES)" --format="table(name,zone,status)" > $TMP_FILE

# Check if any instances were found
# The header line will always be there, so check for more than 1 line
if [[ $(wc -l < $TMP_FILE) -le 1 ]]; then
    echo "No instances found in any us-east zones. Exiting."
    exit 0
fi

# 2. Let the user select instances using gum filter
# We use `tail -n +2` to skip the header line from the gcloud output
SELECTED_INSTANCE=$(tail -n +2 $TMP_FILE | gum filter --placeholder "Pick instances to manage (space to select, enter to confirm)..." \
  "${GUM_FILTER_HEADER_STYLE}" --header="Select GCP Instances")

# Exit if no instances were selected
if [ -z "$SELECTED_INSTANCE" ]; then
    echo "No instances selected. Exiting."
    exit 1
fi

# 3. Ask the user for the desired action (start or stop)
ACTION=$(gum choose "start" "stop" "${GUM_CHOOSE_HEADER_STYLE}" --header "Choose an action to perform on the selected instances:")

# Exit if no action was chosen
if [ -z "$ACTION" ]; then
    echo "No action selected. Exiting."
    exit 1
fi

# 4. Echo the command for each selected instance (Dry Run)

# Use a while loop to process each line of the multi-line selection
    # awk is used to extract the first and second columns (NAME and ZONE)
INSTANCE_NAME=$(echo "$SELECTED_INSTANCE" | awk '{print $1}')
ZONE=$(echo "$SELECTED_INSTANCE" | awk '{print $2}')

if [ -n "$INSTANCE_NAME" ] && [ -n "$ZONE" ]; then
  to_confirm="gcloud compute instances \"$ACTION\" \"$INSTANCE_NAME\" --zone=\"$ZONE\""
  gum confirm "Approve? ${to_confirm}" && gcloud compute instances "$ACTION" "$INSTANCE_NAME" --zone="$ZONE" --async
fi

rm $TMP_FILE
