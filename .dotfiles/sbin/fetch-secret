#!/bin/bash

set -e

# ALL but the actual secret goes into stderr. Return code is 1 upon failure
# of any kind.
secret-get() {
    gist_id=$1

    if [ -z "$gist_id" ]; then
        gist_id=$(gum input --placeholder "Enter gist ID") >&2
    fi

    if [ -z "$gist_id" ]; then
        gum style --foreground 196 "Error: Gist ID required" >&2
        return 1
    fi

    gum style --foreground 212 "Retrieving secret from gist: $gist_id" >&2

    if decrypted=$(gh gist view "$gist_id" --raw 2>/dev/null | base64 -d | age -d 2>&1); then
        echo "" >&2
        gum style --foreground 112 "âœ“ Decrypted successfully:" >&2
        echo "" >&2
        echo "$decrypted"
        echo "" >&2
    else
        gum style --foreground 196 "âœ— Failed to decrypt. Check your passphrase and gist ID." >&2
        return 1
    fi
}

secret-get "$@"
